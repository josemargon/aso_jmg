# PR0601 Introducción a Powershell

## Bloque 1: Descubrimiento y ayuda

1. Búsqueda por nombre (Sustantivo): lista todos los comandos disponibles en el sistema que tengan la palabra Service en su nombre (noun) para identificar qué herramientas tienes para gestionar servicios.

`Get-Command -Noun *Service*`

```
CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Function        Get-NetFirewallServiceFilter                       2.0.0.0    NetSecurity
Function        Get-SMServerService                                1.0.0.0    ServerManagerTasks
Function        Set-NetFirewallServiceFilter                       2.0.0.0    NetSecurity
Cmdlet          Get-Service                                        3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          New-Service                                        3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          New-WebServiceProxy                                3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Restart-Service                                    3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Resume-Service                                     3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Set-Service                                        3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Start-Service                                      3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Stop-Service                                       3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Suspend-Service                                    3.1.0.0    Microsoft.PowerShell.Management
```

2. Búsqueda por acción (Verbo): lista todos los comandos disponibles cuya acción sea Stop (detener), independientemente de lo que detengan.

`Get-Command -Verb Stop`

```
CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Function        Stop-DscConfiguration                              1.1        PSDesiredStateConfiguration
Function        Stop-Dtc                                           1.0.0.0    MsDtc
Function        Stop-DtcTransactionsTraceSession                   1.0.0.0    MsDtc
Function        Stop-EtwTraceSession                               1.0.0.0    EventTracingManagement
Function        Stop-NetEventSession                               1.0.0.0    NetEventPacketCapture
Function        Stop-PcsvDevice                                    1.0.0.0    PcsvDevice
Function        Stop-RDVirtualDesktopCollectionJob                 2.0.0.0    RemoteDesktop
Function        Stop-ScheduledTask                                 1.0.0.0    ScheduledTasks
Function        Stop-SilLogging                                    2.0.0.0    SoftwareInventoryLogging
Function        Stop-SMPerformanceCollector                        1.0.0.0    ServerManagerTasks
Function        Stop-StorageDiagnosticLog                          2.0.0.0    Storage
Function        Stop-StorageJob                                    2.0.0.0    Storage
Function        Stop-Trace                                         1.0.0.0    PSDiagnostics
Cmdlet          Stop-AppvClientConnectionGroup                     1.0.0.0    AppvClient
Cmdlet          Stop-AppvClientPackage                             1.0.0.0    AppvClient
Cmdlet          Stop-Computer                                      3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Stop-DtcDiagnosticResourceManager                  1.0.0.0    MsDtc
Cmdlet          Stop-IscsiVirtualDiskOperation                     2.0.0.0    IscsiTarget
Cmdlet          Stop-Job                                           3.0.0.0    Microsoft.PowerShell.Core
Cmdlet          Stop-Process                                       3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Stop-ReFSDedupJob                                  2.0.0.0    Microsoft.ReFsDedup.Commands
Cmdlet          Stop-Service                                       3.1.0.0    Microsoft.PowerShell.Management
Cmdlet          Stop-Transcript                                    3.0.0.0    Microsoft.PowerShell.Host
```

3. Uso de la ayuda: muestra por pantalla la ayuda detallada del comando Get-Process, pero asegúrate de que se muestren específicamente los ejemplos de uso.

Para que nos muestre la ayuda correctamente haremos un `update-help`, asi descargará todos los archivos de ayuda para los comandos.

`Get-Help Get-Process -Examples`

```
NOMBRE
    Get-Process

SINOPSIS
    Gets the processes that are running on the local computer or a remote computer.


    --------- Example 1: Get a list of all running processes on the local computer ---------

    ```powershell
    Get-Process
    ```

    This command gets a list of all running processes on the local computer. For a definition of each
    display column, see the [NOTES](#notes) section.

    To see all properties of a **Process** object, use `Get-Process | Get-Member`. By default,
    PowerShell displays certain property values using units such as kilobytes (K) and megabytes (M). The
    actual values when accessed with the member-access operator (`.`) are in bytes.
```

## Bloque 2: Exploración de objetos

1. Introspección de tipos: ejecuta el comando para obtener la fecha actual (Get-Date) pero canaliza su salida para ver la lista de sus Miembros (Members).

`Get-Date | Get-Member`

```
   TypeName: System.DateTime

Name                 MemberType     Definition
----                 ----------     ----------
Add                  Method         datetime Add(timespan value)
AddDays              Method         datetime AddDays(double value)
AddHours             Method         datetime AddHours(double value)
AddMilliseconds      Method         datetime AddMilliseconds(double value)
AddMinutes           Method         datetime AddMinutes(double value)
AddMonths            Method         datetime AddMonths(int months)
AddSeconds           Method         datetime AddSeconds(double value)
AddTicks             Method         datetime AddTicks(long value)
AddYears             Method         datetime AddYears(int value)
CompareTo            Method         int CompareTo(System.Object value), int CompareTo(datetime value), int IComparab...
Equals               Method         bool Equals(System.Object value), bool Equals(datetime value), bool IEquatable[d...
GetDateTimeFormats   Method         string[] GetDateTimeFormats(), string[] GetDateTimeFormats(System.IFormatProvide...
GetHashCode          Method         int GetHashCode()
GetObjectData        Method         void ISerializable.GetObjectData(System.Runtime.Serialization.SerializationInfo ...
GetType              Method         type GetType()
GetTypeCode          Method         System.TypeCode GetTypeCode(), System.TypeCode IConvertible.GetTypeCode()
```

2. Identificación de Propiedades vs Métodos: usando el comando Get-Member sobre un proceso cualquiera (ej: Get-Process), identifica el nombre de un Método que permita finalizar (matar) el proceso.

`Get-Process | Get-Member`

Haciendo esto encontraremos un proceso concreto llamado kill.

```
Kill                       Method         void Kill()
```

## Bloque 3: El Pipeline (selección y ordenación)

1. Selección de columnas: obtén la lista de todos los procesos, pero muestra por pantalla únicamente las propiedades Id y ProcessName. El resto de información debe ser descartada.

`Get-Process | Select-Object Id, ProcessName`

```
  Id ProcessName
  -- -----------
3868 AggregatorHost
5396 audiodg
2240 AzureArcSysTray
4072 backgroundTaskHost
 596 csrss
 668 csrss
7096 ctfmon
1308 dwm
4808 explorer
 436 fontdrvhost
 476 fontdrvhost
4284 GenValObj
   0 Idle
 828 lsass
2388 MoNotificationUx
5096 MoNotificationUx
4744 MoUsoCoreWorker
2840 MpDefenderCoreService
2504 msdtc
```

2. Ordenación básica: lista todos los procesos del sistema, ordenados por su consumo de CPU de forma descendente (el que más consume primero).

`Get-Process | Sort-Object CPU -Descending`

```
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
   2239       0       36        172     177,39      4   0 System
    711      32    40052     108384     151,70   5124   1 WindowsTerminal
    886     227   288348     269228      62,23   3344   0 MsMpEng
    893      68    62940     115284      18,75   1308   1 dwm
   2909     110    51712     255032      15,67   4808   1 explorer
    391      15     8916      24668       7,59   2960   0 svchost
    400      20     6364      35084       6,23   6196   0 svchost
    969      17     5776      16364       4,83   1000   0 svchost
    430      22    14128      41880       4,75   4744   0 MoUsoCoreWorker
    588      37   102908      78400       4,73   6504   1 ServerManager
    413      14    14576      21700       4,33   1440   0 svchost
    735      24    19676      55928       4,30   2788   0 svchost
    806      37    78556     126600       4,08   5584   1 powershell
    231      12     3020      17860       3,20    836   0 svchost
   1280      89   102728     213128       3,03   6188   1 SearchHost
    172      10     2380       8216       2,94   1404   0 VBoxService
   1189      23     6688      26216       2,78    828   0 lsass
    577      12     4684      11412       2,58    816   0 services
    315       9     5952      19164       2,56   2312   0 svchost
      0      14    10508      80532       2,09    124   0 Registry
    312      16    11448      15528       1,84   5964   0 svchost
    568      18     6100      38216       1,75   3100   1 sihost
    338      16     1904       6864       1,69    668   1 csrss
    948      41    41552     114520       1,67   6212   1 StartMenuExperienceHost
```

3. Formato de tabla: obtén los servicios del sistema y fuerza la salida para que se muestre como una tabla (Format-Table) que se auto-ajuste (-AutoSize) al ancho de la ventana.

`Get-Service | Format-Table -AutoSize`

```
Status  Name                                     DisplayName
------  ----                                     -----------
Stopped ALG                                      Servicio de puerta de enlace de nivel de aplicación
Stopped AppIDSvc                                 Identidad de aplicación
Running Appinfo                                  Información de la aplicación
Stopped AppMgmt                                  Administración de aplicaciones
Stopped AppReadiness                             Preparación de aplicaciones
Stopped AppVClient                               Microsoft App-V Client
Stopped AppXSvc                                  Servicio de implementación de AppX (AppXSVC)
Running AudioEndpointBuilder                     Compilador de extremo de audio de Windows
Running Audiosrv                                 Audio de Windows
Stopped AxInstSV                                 Instalador de ActiveX (AxInstSV)
Running BFE                                      Motor de filtrado de base
Stopped BITS                                     Servicio de transferencia inteligente en segundo plano (BITS)
Stopped BluetoothUserService_9d469               BluetoothUserService_9d469
Running BrokerInfrastructure                     Servicio de infraestructura de tareas en segundo plano
Stopped BTAGService                              BTAGService
Stopped BthAvctpSvc                              BthAvctpSvc
Stopped bthserv                                  Servicio de compatibilidad con Bluetooth
Running camsvc                                   Servicio Administrador de funcionalidad de acceso
Stopped CaptureService_9d469                     CaptureService_9d469
Running cbdhsvc_9d469                            Servicio de usuario del portapapeles_9d469
```

## Bloque 4: Filtrado y lógica (Where-Object)

1. Filtrado exacto: muestra una lista de los servicios cuyo estado (Status) sea exactamente igual (-eq) a “Running”.

`Get-Service | Where-Object { $_.Status -eq 'Running' }`

```
Status   Name               DisplayName
------   ----               -----------
Running  Appinfo            Información de la aplicación
Running  AudioEndpointBu... Compilador de extremo de audio de W...
Running  Audiosrv           Audio de Windows
Running  BFE                Motor de filtrado de base
Running  BrokerInfrastru... Servicio de infraestructura de tare...
Running  camsvc             Servicio Administrador de funcional...
Running  cbdhsvc_9d469      Servicio de usuario del portapapele...
Running  CDPSvc             Servicio de plataforma de dispositi...
Running  CDPUserSvc_9d469   Servicio de usuario de plataforma d...
Running  CoreMessagingRe... CoreMessaging
Running  CryptSvc           Servicios de cifrado
Running  DcomLaunch         Iniciador de procesos de servidor DCOM
Running  DeviceInstall      Servicio de instalación de disposit...
Running  Dhcp               Cliente DHCP
Running  DiagTrack          Experiencias del usuario y telemetr...
```

2. Filtrado numérico: lista los procesos cuyo identificador (Id) sea mayor que (-gt) 2000.

`Get-Process | Where-Object { $_.Id -gt 2000 }`

```
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    120       8     2600       9844       0,22   3868   0 AggregatorHost
    229      15     3620      18384       0,05   2240   1 AzureArcSysTray
    512      21     6456      33904       0,75   7096   1 ctfmon
    235      19     3988      15940       0,13   5072   1 dllhost
   2900     109    51780     255152      15,86   4808   1 explorer
    195      12     2708      18608       0,31   2388   1 MoNotificationUx
    168      12     2432      13472       0,02   5096   1 MoNotificationUx
    424      22    14388      41832       4,75   4744   0 MoUsoCoreWorker
    361      14     9052      22572       0,44   2840   0 MpDefenderCoreService
    248      15     3252      12808       0,05   2504   0 msdtc
    878     227   294752     285516      62,30   3344   0 MsMpEng
    210      10     4332      13912       0,27   2260   0 NisSrv
    155      11     2368      11616       1,33   5800   1 OpenConsole
    713      37    78740     126844       4,50   5584   1 powershell
    599      27     8640      51856       0,84   6332   1 RuntimeBroker
    349      18     4768      32304       1,16   6360   1 RuntimeBroker
    204      12     2600      20348       0,14   6888   1 RuntimeBroker
   1280      89   102728     213128       3,03   6188   1 SearchHost
    254      13     3296      16076       0,19   5808   0 SecurityHealthService
```

3. Filtrado con comodines: busca y muestra todos los procesos cuyo nombre (Name) comience por la letra “s” utilizando el operador -like y el comodín adecuado.

`Get-Process | Where-Object { $_.ProcessName -like 's*' }`

```
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
   1280      89   102728     213128       3,03   6188   1 SearchHost
    254      13     3292      16076       0,19   5808   0 SecurityHealthService
    588      37   102908      78400       4,73   6504   1 ServerManager
    577      12     4692      11392       2,58    816   0 services
    702      31    15036      71896       0,48   6852   1 ShellExperienceHost
    360      19     6300      38320       0,27   4160   1 ShellHost
    562      18     6064      38196       1,75   3100   1 sihost
     58       4     1112       1616       0,19    448   0 smss
    448      22     5844      21776       0,19   2516   0 spoolsv
    945      41    41500     114480       1,67   6212   1 StartMenuExperienceHost
    273      11     2392      12148       1,20    580   0 svchost
    229      12     2968      17836       3,20    836   0 svchost
    156       9     1580       9652       0,05    848   0 svchost
    866      22     6880      33480       1,53    948   0 svchost
    962      17     5824      16428       4,86   1000   0 svchost
    115       7     1280       7560       0,02   1064   0 svchost
    212      12     2320      13540       0,02   1140   0 svchost
```

## Bloque 5: Agrupación y estadísticas

1. Agrupación de datos: agrupa todos los servicios del sistema en función de su Status. El comando debe devolverte cuántos hay en cada grupo.

`Get-Service | Group-Object Status`

```
Count Name                      Group
----- ----                      -----
  157 Stopped                   {ALG, AppIDSvc, AppMgmt, AppReadiness...}
   79 Running                   {Appinfo, AudioEndpointBuilder, Audiosrv, BFE...}
```

2. Cálculo estadístico: obtén el listado de archivos del directorio actual (Get-ChildItem). Usando una tubería, calcula el promedio (Average) de la propiedad Length (tamaño) de todos los archivos.

`Get-ChildItem -File | Measure-Object -Property Length -Average`

```
Count    : 2
Average  : 1990
Sum      :
Maximum  :
Minimum  :
Property : Length
```

## Bloque 6: Gestión del Historial

1. Consulta de actividad: muestra por pantalla la lista de los últimos comandos que has ejecutado en la sesión actual.

`Get-History`

```
 Id CommandLine
  -- -----------
   1 Get-Command -Noun *Service*
   2 Get-Command -Verb Stop
   3 Get-Help Get-Process -Examples
   4 Get-Date | Get-Member
   5 Get-Process | Get-Member
   6 Get-Process | Select-Object Id, ProcessName
   7 Get-Process | Sort-Object CPU -Descending | Select-Object Id, ProcessName, CPU
   8 Get-Process | Sort-Object CPU -Descending
   9 Get-Service | Format-Table -AutoSize
  10 Get-Service | Where-Object { $_.Status -eq 'Running' }
  11 Get-ChildItem -File | Measure-Object -Property Length -Average
  12 cd "C:\Program Files (x86)\Internet Explorer"
  13 Get-ChildItem -File | Measure-Object -Property Length -Average
  14 cd
  15 cd "C:\Users\Administrador\Desktop"
  16 Get-History | Export-Csv -Path "historial_lab.csv" -NoTypeInformation
  17 (Get-Process notepad).Kill()
```

2. Exportación de datos: exporta todo tu historial de comandos actual a un archivo en formato CSV llamado historial_lab.csv.

Como no especificamos la ruta en la que se crea el archivo csv, se crea en la dirección en la que estamos situados en powershell.

`Get-History | Export-Csv -Path "historial_lab.csv" -NoTypeInformation`

![csv](..\imagenes\archivocsv.png)