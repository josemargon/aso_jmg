# pr0606

## Objetivo

Eres el responsable de infraestructura de una plataforma de E-Commerce. Un sistema de inventario de hace 10 años está registrando los movimientos de stock en un archivo de texto con un formato inconsistente. Necesitas procesar estos datos para generar un informe de discrepancias críticas en formato CSV que el equipo de almacén pueda importar en Excel.

## Datos de entrada

```
$movimientosCrudos = @"
[LOG-OK] SKU:A199 :: 2024.01.10_08:00 :: Item:Smartphone_X :: Qty:50 :: Status:In_Stock
[LOG-ALERT] SKU:B250 :: 10-01-2024 09:15 :: Item:LAPTOP-PRO :: Qty:-5 :: Status:Damaged
[LOG-OK] SKU:C312 :: 2024/01/10_10:30 :: Item:tablet_air :: Qty:120 :: Status:In_Stock
[LOG-CRIT] SKU:D400 :: 11/01/2024_11:45 :: Item:UNKNOWN_ITEM :: Qty:0 :: Status:Out_Of_Order
"@
```

## Requisitos

- Filtrado de seguridad: ignora todos los registros que tengan el nivel [LOG-OK]. Solo procesa ALERT y CRIT.
- Normalización de nombres:
    - Todos los nombres de Item deben estar en MAYÚSCULAS.
    - Si el item es “UNKNOWN_ITEM”, debe renombrarse automáticamente a “PENDING_REVIEW”.
- Normalización de fechas: todas las fechas (sin importar si usan puntos, guiones o barras) deben transformarse al formato estándar dd/MM/yyyy HH:mm.
- Cálculo de prioridad:
    - Si el status es Damaged, añade una columna llamada ActionRequired con el valor Repair.
    - Si el status es Out_Of_Order, el valor debe ser Replace.
- Salida: genera una lista de [PSCustomObject] y expórtala a un archivo llamado reporte_inventario.csv.

## Script

```
# 1. Datos de entrada
$movimientosCrudos = @"
[LOG-OK] SKU:A199 :: 2024.01.10_08:00 :: Item:Smartphone_X :: Qty:50 :: Status:In_Stock
[LOG-ALERT] SKU:B250 :: 10-01-2024 09:15 :: Item:LAPTOP-PRO :: Qty:-5 :: Status:Damaged
[LOG-OK] SKU:C312 :: 2024/01/10_10:30 :: Item:tablet_air :: Qty:120 :: Status:In_Stock
[LOG-CRIT] SKU:D400 :: 11/01/2024_11:45 :: Item:UNKNOWN_ITEM :: Qty:0 :: Status:Out_Of_Order
"@ -split "`n" # Convertimos el bloque de texto en un array de líneas

# 2. Procesamiento de datos
$reporteFinal = foreach ($linea in $movimientosCrudos) {
    # Requisito: Filtrado de seguridad (Ignorar [LOG-OK])
    if ($linea -match "\[LOG-OK\]" -or [string]::IsNullOrWhiteSpace($linea)) {
        continue
    }

    # Extraer datos usando Regex (capturamos los valores después de los dos puntos)
    # Patrón: Busca el texto después de SKU:, Fecha (entre ::), Item:, Qty: y Status:
    if ($linea -match "SKU:(?<sku>.*?) :: (?<fecha>.*?) :: Item:(?<item>.*?) :: Qty:(?<qty>.*?) :: Status:(?<status>.*)") {
        
        $itemOriginal = $Matches['item'].Trim()
        $fechaOriginal = $Matches['fecha'].Trim()
        $status = $Matches['status'].Trim()

        # Requisito: Normalización de nombres
        $itemProcesado = $itemOriginal.ToUpper()
        if ($itemProcesado -eq "UNKNOWN_ITEM") {
            $itemProcesado = "PENDING_REVIEW"
        }

        # Requisito: Normalización de fechas
        # Limpiamos separadores inconsistentes por espacios/guiones estándar para que Get-Date lo entienda
        $fechaLimpia = $fechaOriginal -replace '[\._/]', '-'
        $fechaFormateada = (Get-Date $fechaLimpia).ToString("dd/MM/yyyy HH:mm")

        # Requisito: Cálculo de prioridad (ActionRequired)
        $accion = switch ($status) {
            "Damaged"      { "Repair" }
            "Out_Of_Order" { "Replace" }
            Default        { "Check" }
        }

        # 3. Creación del objeto normalizado
        [PSCustomObject]@{
            SKU            = $Matches['sku'].Trim()
            Fecha          = $fechaFormateada
            Item           = $itemProcesado
            Cantidad       = $Matches['qty'].Trim()
            Estado         = $status
            ActionRequired = $accion
        }
    }
}

# 4. Salida: Exportación a CSV
$reporteFinal | Export-Csv -Path "reporte_inventario.csv" -NoTypeInformation -Encoding utf8

# Feedback visual en consola
Write-Host "Procesamiento completado. Se ha generado 'reporte_inventario.csv'." -ForegroundColor Green
$reporteFinal | Format-Table
```

## Resultado

```
SKU  Fecha            Item           Cantidad Estado       ActionRequired
---  -----            ----           -------- ------       --------------
B250 10/01/2024 09:15 LAPTOP-PRO     -5       Damaged      Repair        
D400 11/01/2024 12:45 PENDING_REVIEW 0        Out_Of_Order Replace       
```