# PR0604: Manipulación de colecciones en powerShell

## Bloque I: Arrays fijos

1. Reconfiguración de DNS y Verificación

    - Declara el array con los valores iniciales: 192.168.1.10 (Primario) y 10.0.0.50 (Secundario erróneo).

    ```
    $dnsServers = @("192.168.1.10", "10.0.0.50")
    ```

    - Muestra en pantalla: “Configuración actual: [Primario] - [Secundario]”.

    ```
    Write-Host "Configuración actual: $($dnsServers[0]) - $($dnsServers[1])"
    Configuración actual: 192.168.1.10 - 10.0.0.50
    ```

    - Accede directamente al índice correspondiente y cambia la IP del secundario por la de Google: 8.8.8.8.

    ```
    $dnsServers[1] = "8.8.8.8"
    ```

    - Muestra en pantalla el número total de servidores DNS configurados.

    ```
    Write-Host "Total de servidores DNS configurados: $($dnsServers.Count)"
    Total de servidores DNS configurados: 2
    ```

    - Muestra la configuración final corregida.

    ```
    Write-Host "Configuración final corregida: $($dnsServers[0]) - $($dnsServers[1])"
    Configuración final corregida: 192.168.1.10 - 8.8.8.8
    ```

2. Rotación de logs de backups (LIFO - Last In, First Out)

    - Declara el array con las siguientes cadenas: Backup_Lunes.zip, Backup_Martes.zip, Backup_Miercoles.zip.

    ```
    $backups = @("Backup_Lunes.zip", "Backup_Martes.zip", "Backup_Miercoles.zip")
    ```

    - Guarda en una variable $oldest el primer elemento.

    ```
    $oldest = $backups[0]
    ```

    - Guarda en una variable $newest el último elemento.

    ```
    $newest = $backups[-1]
    ```

    - El backup del Miércoles ha salido corrupto. Modifica el último elemento del array añadiéndole el texto “ (CORRUPTO)” al final del nombre.

    ```
    $backups[2] = $backups[2] + " (CORRUPTO)"
    ```

    - Imprime un resumen: “Rotación de backups: Del [Viejo] al [Nuevo]”.

    ```
    Write-Host "Rotación de backups: Del $oldest al $($backups[2])"
    Rotación de backups: Del Backup_Lunes.zip al Backup_Miercoles.zip (CORRUPTO)
    ```

## Bloque II: ArrayLists

3. Gestión de Cola de incidencias (Priorización)

    - Crea un ArrayList vacío.

    ```
    $incidencias = New-Object System.Collections.ArrayList
    ```

    - Añade las incidencias: “Monitor parpadea” y “Ratón no va”. (Recuerda ocultar la salida por pantalla del .Add()).

    ```
    [void]$incidencias.Add("Monitor parpadea")
    [void]$incidencias.Add("Ratón no va")
    ```

    - Llega una urgencia: Inserta en la posición 0 la incidencia: “SERVIDOR CAÍDO”.

    ```
    $incidencias.Insert(0, "SERVIDOR CAÍDO")
    ```

    - El técnico resuelve la incidencia del “Ratón”. Búscala por su nombre y elimínala de la lista.

    ```
    $incidencias.Remove("Ratón no va")
    ```

    - Imprime la lista actual de tareas pendientes y cuenta cuántas quedan.

    ```
    Write-Host "`nTotal de incidencias pendientes: $($incidencias.Count)"

    Total de incidencias pendientes: 2
    ```

    ```
    foreach ($tarea in $incidencias) {
    >>     Write-Host "- $tarea"
    >> }
    - SERVIDOR CAÍDO
    - Monitor parpadea
    ```

4. Validación de lista negra de IPs (Seguridad)

    - Inicializa un ArrayList con las IPs ya bloqueadas: 10.10.10.5, 192.168.50.4, 80.80.80.80.

    ```
    $listaNegra = New-Object System.Collections.ArrayList
    [void]$listaNegra.Add("10.10.10.5")
    [void]$listaNegra.Add("192.168.50.4")
    [void]$listaNegra.Add("80.80.80.80")
    ```

    - Declara una variable $nuevaAmenaza = "192.168.50.4".

    ```
    $nuevaAmenaza = "192.168.50.4"
    ```

    - Usa una estructura if para:

        - Si la IP ya está en la lista, muestra: “La IP [IP] ya estaba bloqueada. No se hace nada.”

        - Si no está, añádela a la lista y muestra: “IP [IP] añadida a la lista negra.”

    ```
    if ($listaNegra.Contains($nuevaAmenaza)) {
    >>     Write-Host "La IP $nuevaAmenaza ya estaba bloqueada. No se hace nada." -ForegroundColor Yellow
    >> } else {
    >>     [void]$listaNegra.Add($nuevaAmenaza)
    >>     Write-Host "IP $nuevaAmenaza añadida a la lista negra." -ForegroundColor Red
    >> }
    La IP 192.168.50.4 ya estaba bloqueada. No se hace nada.
    ```

    - Muestra la lista final ordenada alfabéticamente

    ```
    Write-host "`n--- Lista Negra Final Ordenada ---"
    foreach ($ip in $listaNegra) {
    >>     Write-Host $ip
    >> }
    10.10.10.5
    192.168.50.4
    80.80.80.80
    ```

## Bloque III: Listas genéricas

5. Hardening de puertos de Firewall (List[int])

    - Instancia una nueva lista genérica que solo acepte Enteros: [System.Collections.Generic.List[int]]::new().

    ```
    $puertosPermitidos = [System.Collections.Generic.List[int]]::new()
    ```

    - Añade los puertos estándar: 80, 443, 53.

    ```
    $puertosPermitidos.Add(80)
    $puertosPermitidos.Add(443)
    $puertosPermitidos.Add(53)
    ```

    - Por error, alguien abrió el puerto Telnet (23). Añádelo a la lista.

    ```
    $puertosPermitidos.Add(23)
    ```

    - Auditoría de seguridad: Elimina el puerto 23 de la lista.

    ```
    $puertosPermitidos.Remove(23)
    ```

    - Intenta añadir (solo escribe la línea comentada) el texto “HTTP” a la lista y explica en un comentario qué error daría.

    ```
    $puertosPermitidos.Add("HTTP")
    No se puede convertir el argumento "item", con el valor: "HTTP", para "Add", al tipo "System.Int32": "No se puede convertir el valor
    "HTTP" al tipo "System.Int32". Error: "La cadena de entrada no tiene el formato correcto.""
    En línea: 1 Carácter: 1
    + $puertosPermitidos.Add("HTTP")
    + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        + CategoryInfo          : NotSpecified: (:) [], MethodException
        + FullyQualifiedErrorId : MethodArgumentConversionInvalidCastArgument
    ```

    Da error porque hemos indicado INT en la lista por lo que todo lo que añadamos deben ser números.

    - Muestra la lista de puertos permitidos ordenada de menor a mayor.

    ```
    $puertosPermitidos.Sort()
    ```

    ```
    $puertosPermitidos | ForEach-Object { Write-Host "Puerto habilitado: $_" }
    Puerto habilitado: 53
    Puerto habilitado: 80
    Puerto habilitado: 443
    ```

6. Inventario de servicios críticos (List[string])

    - Crea una lista genérica de Strings a partir de un array existente (::new($array)): Array origen: Spooler, W3SVC, LanmanWorkstation.

    Creamos el array

    ```
    $serviciosArray = @("Spooler", "W3SVC", "LanmanWorkstation")
    ```

    ```
    $listaServicios = [System.Collections.Generic.List[string]]::new([string[]]$serviciosArray)
    ```

    - Te das cuenta de que falta el servicio de actualizaciones. Añade “wuauserv”.

    ```
    $listaServicios.Add("wuauserv")
    ```

    - Ordena la lista alfabéticamente.

    ```
    $listaServicios.Sort()
    ```

    - Recorre la lista (foreach) y para cada elemento muestra el mensaje: “Monitorizando servicio: [NombreServicio]… OK”.

    ```
    foreach ($servicio in $listaServicios) {
    >>     Write-Host "Monitorizando servicio: [$servicio]… OK"
    >> }
    Monitorizando servicio: [LanmanWorkstation]… OK
    Monitorizando servicio: [Spooler]… OK
    Monitorizando servicio: [W3SVC]… OK
    Monitorizando servicio: [wuauserv]… OK
    ```

## Bloque IV: Manipulación de texto

7. Análisis de Log de usuario

    Entrada: $logLine = " User: admin ; IP: 192.168.1.55 ; Status: Failed " (Nota los espacios extra al principio y final).

    - Limpia los espacios en blanco sobrantes del principio y el final de la cadena original.

    ```
    $logLimpio = $logLine.Trim()
    ```

    - Divide la cadena usando el punto y coma ; como separador.

    ```
    $partes = $logLimpio.Split(";")
    ```

    - El primer elemento será “User: admin”. Vuelve a dividirlo para quedarte solo con “admin”.

    ```
    $usuarioRaw = $partes[0].Split(":")[1]
    $usuario = $usuarioRaw.Trim()
    ```

    - El segundo elemento es la IP. Límpialo para obtener solo “192.168.1.55”.

    ```
    $ipRaw = $partes[1].Split(":")[1]
    $ip = $ipRaw.Trim()
    ```

    - Muestra un mensaje final claro: “ALERTA: El usuario [Usuario] intentó conectar desde [IP]”.

    ```
    Write-Host "ALERTA: El usuario $usuario intentó conectar desde $ip"
    ALERTA: El usuario admin intentó conectar desde 192.168.1.55
    ```

8. Generador de CSV para recursos humanos

    - Tienes tres variables con correos: $m1="ana@empresa.com", $m2="luis@empresa.com", $m3="bea@empresa.com".

    ```
    $m1 = "ana@empresa.com"
    $m2 = "luis@empresa.com"
    $m3 = "bea@empresa.com"
    ```

    - Crea un array temporal que contenga esas tres variables.

    ```
    $arrayCorreos = @($m1, $m2, $m3)
    ```

    - Utiliza el operador -join para crear una única cadena de texto separada por comas ,.

    ```
    $cadenaCorreos = $arrayCorreos -join ","
    ```

    - Al resultado final, añádele manualmente el encabezado “EmailAddress,” al principio.

    ```
    $resultadoFinal = "EmailAddress," + $cadenaCorreos
    ```

    - Muestra el resultado, que debería parecerse al contenido de un archivo .csv.

    ```
    Write-Host $resultadoFinal
    EmailAddress,ana@empresa.com,luis@empresa.com,bea@empresa.com
    ```