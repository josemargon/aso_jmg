# PR0605

## Objetivo

Eres el administrador de sistemas de una empresa de seguridad. Un servidor legacy (antiguo) está generando unos logs de aplicación con un formato terrible y poco estándar. El departamento de seguridad necesita un informe limpio en CSV para poder auditar quién ha accedido al sistema.

No puedes cambiar cómo el servidor genera los logs. Tu única opción es crear un script en PowerShell que “digiera” ese texto crudo y lo transforme en información estructurada.

## Datos de entrada

```
$logCrudo = @"
[INFO] ID:8842 :: 2023/11/01_10:00 :: User:admin_01 :: Action:Login_Success
[ERROR] ID:9921 :: 2023/11/01_10:05 :: User:guest_user :: Action:Auth_Fail (Pass)
[WARN] ID:8843 :: 2023-11-01 10:15 :: User:dev_team :: Action:Upload_Limit_Exceeded
[CRITICAL] ID:1001 :: 01-11-2023_10:20 :: User:ROOT :: Action:Service_Stop
"@
```

## Los requisitos

Tu script debe procesar $logCrudo y cumplir estrictamente con los siguientes puntos.

- Normalización de fechas: todas las fechas deben salir en formato estándar ISO yyyy-MM-dd HH:mm.
- Limpieza de usuarios:
    - Deben estar todos en minúsculas.
    - Si el usuario es “ROOT”, debe ser renombrado automáticamente a “administrator” por política de seguridad.
- Clasificación de gravedad:
    - Debes extraer el nivel de log (INFO, ERROR, etc.) sin los corchetes [].
- Filtrado:
    - Solo nos interesan las líneas que NO sean [INFO]. Ignora los logs informativos.
- Salida estructurada:
    - El script no debe escribir texto plano en la consola. Debe generar Objetos PowerShell (PSCustomObject) y finalmente exportarlos a un archivo reporte_seguridad.csv. Para crear esta tabla usa [PSCustomObject]@{}.

## Script

```
$logCrudo = @"
[INFO] ID:8842 :: 2023/11/01_10:00 :: User:admin_01 :: Action:Login_Success
[ERROR] ID:9921 :: 2023/11/01_10:05 :: User:guest_user :: Action:Auth_Fail (Pass)
[WARN] ID:8843 :: 2023-11-01 10:15 :: User:dev_team :: Action:Upload_Limit_Exceeded
[CRITICAL] ID:1001 :: 01-11-2023_10:20 :: User:ROOT :: Action:Service_Stop
"@

# Procesamos todas las líneas primero
$lineas = $logCrudo -split "`n" | ForEach-Object { $_.Trim() }

$resultado = foreach ($linea in $lineas) {
    if ($linea -match "\[(?<Severity>.*?)\]\s*ID:(?<ID>\d+)\s*::\s*(?<Date>.*?)\s*::\s*User:(?<User>.*?)\s*::\s*Action:(?<Action>.*)") {
        
        # 1. Severidad
        $sev = $Matches['Severity'].Trim()

        # 2. FILTRO CRÍTICO:
        if ($sev -eq "INFO") { continue }

        # 3. Normalizar Usuario
        $userRaw = $Matches['User'].ToLower().Trim()
        $userFinal = if ($userRaw -eq "root") { "administrator" } else { $userRaw }

        # 4. Normalizar Fecha
        $dateRaw = $Matches['Date'] -replace '_', ' '
        $timeStamp = [DateTime]::Parse($dateRaw).ToString("yyyy-MM-dd HH:mm")

        # 5. Crear la estructura
        [PSCustomObject]@{
            TimeStamp = $timeStamp
            Severity  = $sev
            User      = $userFinal
            EventID   = $Matches['ID']
            Action    = $Matches['Action'].Trim()
        }
    }
}

# 6. Salida
$resultado | Format-Table
$resultado | Export-Csv -Path "reporte_seguridad.csv" -NoTypeInformation -Encoding utf8
```

## Resultado

```
TimeStamp        Severity User          EventID Action               
---------        -------- ----          ------- ------               
2023-11-01 10:05 ERROR    guest_user    9921    Auth_Fail (Pass)     
2023-11-01 10:15 WARN     dev_team      8843    Upload_Limit_Exceeded
2023-11-01 10:20 CRITICAL administrator 1001    Service_Stop         
```